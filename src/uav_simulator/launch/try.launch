<launch>
  <!-- Uses your existing scout.launch which already starts Gazebo,
       RViz, gmapping, move_base, static TFs, filters, etc. -->
    <arg name="robot_namespace" default="/"/>
    <arg name="wname" default="construction_site_big_v"/>
    <arg name="planner" default="teb"/>
  
    <include file="$(find gazebo_ros)/launch/empty_world.launch">
      <arg name="world_name" value="$(find uav_simulator)/worlds/floorplan3/$(arg wname).world"/>
      <!-- <arg name="world_name" value="$(find scout_gazebo_sim)/worlds/$(arg wname).world"/> -->
      <arg name="paused" value="true"/>
      <arg name="use_sim_time" value="true"/>
      <arg name="gui" value="true"/>
      <arg name="headless" value="false"/> 
      <arg name="debug" value="true"/>
    </include>
    
  <!-- ========== UAV (namespaced) ========== -->
  <group ns="uav1">

    <!-- Put the UAV URDF under /uav1/robot_description -->
    <param name="robot_description"
           command="cat '$(find uav_simulator)/urdf/quadcopter.urdf'"/>

    <!-- Spawn UAV into the SAME Gazebo started by scout.launch -->
    <!-- Offset position to avoid initial collision with the Scout -->
    <node name="spawn_gazebo_model" pkg="gazebo_ros" type="spawn_model"
          args="-urdf -param robot_description -model uav1 -x 0.0 -y -0.0 -z 0.7 -Y 0.0"
          respawn="false" />

    <!-- The UAV simulator publishes GT topics under /CERLAB/... globally.
         We remap them into the /uav1 namespace and throttle to 30 Hz. -->
    <node pkg="topic_tools" type="throttle" name="gt_pose_throttle"
      args="messages /CERLAB/quadcopter/pose_raw 30 /CERLAB/quadcopter/pose" />

    <node pkg="topic_tools" type="throttle" name="gt_vel_throttle"
      args="messages /CERLAB/quadcopter/vel_raw 30 /CERLAB/quadcopter/vel" />
    <node pkg="topic_tools" type="throttle" name="gt_acc_throttle"
          args="messages /CERLAB/quadcopter/acc_raw 30 /CERLAB/quadcopter/acc" />
    <node pkg="topic_tools" type="throttle" name="gt_odom_throttle"
          args="messages /CERLAB/quadcopter/odom_raw 30 /CERLAB/quadcopter/odom" />

    <!-- UAV TF setup; point it to the namespaced (remapped) pose topic -->
    <include file="$(find uav_simulator)/launch/setupTF.launch">
      <arg name="pose_topic" value="/CERLAB/quadcopter/pose"/>
    </include>

    <!-- Optional keyboard teleop for UAV -->
    <node name="keyboard_control" pkg="uav_simulator" type="keyboard_control"/>
  </group>

  <include file="$(find scout_gazebo_sim)/launch/spawn_scout_mini.launch"></include>
        
    <node name="rviz" pkg="rviz" type="rviz" args="-d $(find scout_description)/rviz/model_display.rviz" />
    
    <!-- <node pkg="tf" type="static_transform_publisher" name="odom_to_base_link" args="0 0.0 0.03 0 0 0 odom base_link 10" /> -->
    
    <node pkg="tf" type="static_transform_publisher" name="base_to_velodyne" args="0 0 0.03 0 0 0 base_link velodyne 10" />
    
    <include file="$(find scout_gazebo_sim)/launch/include/filter_points.launch"></include>

    <include file="$(find scout_gazebo_sim)/launch/include/pc2l.launch"></include>

    <include file="$(find scout_gazebo_sim)/launch/include/gmapping.launch"></include>

    <include file="$(find scout_gazebo_sim)/launch/include/move_base.launch">
        <arg name="planner" value="$(arg planner)"/>
    </include>
    
</launch>